<!-- HTML header for doxygen 1.9.3-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Thorin: Developer Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeParagraphLink.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-interactive-toc.js" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<a href="https://github.com/anydsl/thorin2" class="github-corner" title="View source on GitHub">
    <svg viewBox="0 0 250 250" style="position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true">
    <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Thorin<span id="projectnumber">&#160;1.9.0</span>
   </div>
   <div id="projectbrief">The Higher ORder INtermediate representation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('dev.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Developer Guide </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md13">Compiling and Executing</a></li>
<li class="level1"><a href="#autotoc_md14">Defs and the World</a><ul><li class="level2"><a href="#autotoc_md15">Hash Consing</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md16">Structural vs. Nominal</a></li>
<li class="level1"><a href="#autotoc_md17">Matching IR</a></li>
<li class="level1"><a href="#autotoc_md18">Iterating over the Program</a></li>
</ul>
</div>
<div class="textblock"><p ><a class="anchor" id="md_docs_dev"></a></p>
<p >This guide summaries typicical idioms you want to use when working with Thorin as a developer.</p>
<h1><a class="anchor" id="autotoc_md13"></a>
Compiling and Executing</h1>
<p >Here is a small example that first constructs a <code>main</code> function and simply returns the <code>argc</code>: </p><div class="fragment"><div class="line">World w;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">auto</span> mem_d = Dialect::load(<span class="stringliteral">&quot;mem&quot;</span>, {});</div>
<div class="line">Normalizers normalizers;</div>
<div class="line">mem_d.register_normalizers(normalizers);</div>
<div class="line">Parser::import_module(w, <span class="stringliteral">&quot;mem&quot;</span>, {}, &amp;normalizers);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">auto</span> mem_t  = mem::type_mem(w);</div>
<div class="line"><span class="keyword">auto</span> i32_t  = w.type_int_width(32);</div>
<div class="line"><span class="keyword">auto</span> argv_t = mem::type_ptr(mem::type_ptr(i32_t));</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Cn [mem, i32, Cn [mem, i32]]</span></div>
<div class="line"><span class="keyword">auto</span> main_t = w.cn({mem_t, i32_t, argv_t, w.cn({mem_t, i32_t})});</div>
<div class="line"><span class="keyword">auto</span> main = w.nom_lam(main_t, w.dbg(<span class="stringliteral">&quot;main&quot;</span>));</div>
<div class="line"><span class="keyword">auto</span> [mem, argc, argv, <a class="code hl_enumvalue" href="namespacethorin_1_1clos.html#a5c55a5bd62132e28b49915902ea0117aa2348b9af292e8373483f8ff836d5aac2">ret</a>] = main-&gt;vars&lt;4&gt;();</div>
<div class="line">main-&gt;app(ret, {mem, argc});</div>
<div class="line">main-&gt;make_external();</div>
<div class="line"> </div>
<div class="line">PipelineBuilder builder;</div>
<div class="line">mem_d.register_passes(builder);</div>
<div class="line"><a class="code hl_function" href="namespacethorin.html#aec9c2788533f9e459dcefc479c02e17f">optimize</a>(w, builder);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">auto</span> core_d = Dialect::load(<span class="stringliteral">&quot;core&quot;</span>, {});</div>
<div class="line"><a class="code hl_typedef" href="namespacethorin.html#ab70a3eb6856bc409f9ed3627fff8ab36">Backends</a> backends;</div>
<div class="line">core_d.register_backends(backends);</div>
<div class="line"> </div>
<div class="line">std::ofstream file(<span class="stringliteral">&quot;test.ll&quot;</span>);</div>
<div class="line">Stream s(file);</div>
<div class="line">backends[<span class="stringliteral">&quot;ll&quot;</span>](w, std::cout);</div>
<div class="line">file.close();</div>
<div class="line"> </div>
<div class="line">std::system(<span class="stringliteral">&quot;clang test.ll -o test&quot;</span>);</div>
<div class="line">assert(4 == WEXITSTATUS(std::system(<span class="stringliteral">&quot;./test a b c&quot;</span>)));</div>
<div class="ttc" id="anamespacethorin_1_1clos_html_a5c55a5bd62132e28b49915902ea0117aa2348b9af292e8373483f8ff836d5aac2"><div class="ttname"><a href="namespacethorin_1_1clos.html#a5c55a5bd62132e28b49915902ea0117aa2348b9af292e8373483f8ff836d5aac2">thorin::clos::ret</a></div><div class="ttdeci">@ ret</div><div class="ttdef"><b>Definition:</b> <a href="clos_2autogen_8h_source.html#l00030">autogen.h:30</a></div></div>
<div class="ttc" id="anamespacethorin_html_ab70a3eb6856bc409f9ed3627fff8ab36"><div class="ttname"><a href="namespacethorin.html#ab70a3eb6856bc409f9ed3627fff8ab36">thorin::Backends</a></div><div class="ttdeci">std::map&lt; std::string, std::function&lt; void(World &amp;, std::ostream &amp;)&gt; &gt; Backends</div><div class="ttdef"><b>Definition:</b> <a href="dialects_8h_source.html#l00016">dialects.h:16</a></div></div>
<div class="ttc" id="anamespacethorin_html_aec9c2788533f9e459dcefc479c02e17f"><div class="ttname"><a href="namespacethorin.html#aec9c2788533f9e459dcefc479c02e17f">thorin::optimize</a></div><div class="ttdeci">void optimize(World &amp;world, Passes &amp;passes, std::vector&lt; Dialect &gt; &amp;dialects)</div><div class="ttdoc">See optimize.h for magic numbers.</div><div class="ttdef"><b>Definition:</b> <a href="optimize_8cpp_source.html#l00021">optimize.cpp:21</a></div></div>
</div><!-- fragment --><p> TODO explain</p>
<h1><a class="anchor" id="autotoc_md14"></a>
Defs and the World</h1>
<p ><a class="el" href="classthorin_1_1Def.html">Def</a> is the base class for <em>all</em> nodes/expressions in Thorin. TODO</p>
<h2><a class="anchor" id="autotoc_md15"></a>
Hash Consing</h2>
<p >Each <code>Def</code> is a node in a graph which is maintained in the <a class="el" href="classthorin_1_1World.html">World</a>. <a href="https://en.wikipedia.org/wiki/Hash_consing">Hash consing</a> TODO</p>
<h1><a class="anchor" id="autotoc_md16"></a>
Structural vs. Nominal</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Structural   </th><th class="markdownTableHeadNone">Nominal    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">must be <code>const</code>   </td><td class="markdownTableBodyNone">maybe non-<code>const</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">immutable   </td><td class="markdownTableBodyNone">mutable    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ops form <a href="https://en.wikipedia.org/wiki/Directed_acyclic_graph">DAG</a>   </td><td class="markdownTableBodyNone">ops may be cyclic    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">no recursion   </td><td class="markdownTableBodyNone">may be recursive    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">no <a class="el" href="classthorin_1_1Var.html">Var</a>   </td><td class="markdownTableBodyNone">has <a class="el" href="classthorin_1_1Var.html">Var</a>; get with <a class="el" href="classthorin_1_1Def.html#a18924dc54286147f46fe53e52a8b34ac">Def::var</a>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">hash consed   </td><td class="markdownTableBodyNone">each new instance is fresh    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">build ops first, then the actual node   </td><td class="markdownTableBodyNone">build the actual node first, then <a class="el" href="classthorin_1_1Def.html#af401dbc2a8092cdc438507614174f792">set</a> the ops    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="classthorin_1_1Def.html#a894b8738ff236f12a06b113777877d7f">Def::rebuild</a>   </td><td class="markdownTableBodyNone"><a class="el" href="classthorin_1_1Def.html#a88360b7240d92f32c6be01e52123bd0d">Def::stub</a>   </td></tr>
</table>
<p >Usually, you will encounter <code>defs</code> as <code>const Def*</code>. Use <a class="el" href="classthorin_1_1Def.html#ac79cb2db748fbf0177eb2e6c0fef3fdc">Def::isa_nom</a> to check whether a specific <code>Def</code> is in fact nominal to cast away the <code>const</code> or <a class="el" href="classthorin_1_1Def.html#a1e009bced6c7f37b6316d81ead2ad27e">Def::as_nom</a> to force this cast (and assert if not possible): </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> foo(<span class="keyword">const</span> Def* def) {</div>
<div class="line">    <span class="keywordflow">if</span> (<span class="keyword">auto</span> nom = def-&gt;isa_nom()) {</div>
<div class="line">        <span class="comment">// nom of type Def* - const has been removed!</span></div>
<div class="line">        <span class="comment">// This gives give you access to the non-const methods that only make sense for nominals:</span></div>
<div class="line">        <span class="keyword">auto</span> var = nom-&gt;var();</div>
<div class="line">        <span class="keyword">auto</span> stub = nom-&gt;stub(world, type, debug)</div>
<div class="line">        <span class="comment">// ...</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (<span class="keyword">auto</span> lam = def-&gt;isa_nom&lt;Lam&gt;()) {</div>
<div class="line">        <span class="comment">// lam of type Lam* - const has been removed!</span></div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p> You can also check whether a specific <code>def</code> is really a structural: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> foo(<span class="keyword">const</span> Def* def) {</div>
<div class="line">    <span class="keywordflow">if</span> (<span class="keyword">auto</span> s = def-&gt;isa_structural()) {</div>
<div class="line">        <span class="comment">// s cannot be a nominal</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (<span class="keyword">auto</span> sigma = def-&gt;isa_structural&lt;Sigma&gt;()) {</div>
<div class="line">        <span class="comment">// sigma is of type const Sigma* and cannot be a nominal Sigma</span></div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md17"></a>
Matching IR</h1>
<h1><a class="anchor" id="autotoc_md18"></a>
Iterating over the Program</h1>
<p >There are several ways of doing this. It depends on what exactly you want to achieve and how much structure you need during the traversal. The simplest way is to kick off with <a class="el" href="classthorin_1_1World.html#a5b40a0d582ba6e1b28bc50dc0ceb0840">World::externals</a> and recursively run over <a class="el" href="classthorin_1_1Def.html#a543cbdcb17d574373aa65244dcead8f8">Def::extended_ops</a> like this: </p><div class="fragment"><div class="line">DefSet done;</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; [_, nom] : world.externals())</div>
<div class="line">    visit(done, nom);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> visit(DefSet&amp; done, <span class="keyword">const</span> Def* def) {</div>
<div class="line">    <span class="keywordflow">if</span> (!done.emplace(def).second) <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    do_sth(def);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">auto</span> op : def-&gt;extended_ops())</div>
<div class="line">        visit(done, op);</div>
<div class="line">}</div>
</div><!-- fragment --><p> However, you will most likely want to use the <a class="el" href="passes.html#md_docs_passes">pass</a> or the phase infrastructure. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5 </li>
  </ul>
</div>
</body>
</html>
