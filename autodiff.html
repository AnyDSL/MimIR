<!-- HTML header for doxygen 1.9.3-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Thorin: The automatic differentiation Plugin</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeParagraphLink.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-interactive-toc.js" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<a href="https://github.com/anydsl/thorin2" class="github-corner" title="View source on GitHub">
    <svg viewBox="0 0 250 250" style="position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true">
    <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Thorin<span id="projectnumber">&#160;1.9.0</span>
   </div>
   <div id="projectbrief">The Higher ORder INtermediate representation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('autodiff.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">The automatic differentiation Plugin</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md76">Dependencies</a></li>
<li class="level1"><a href="#autotoc_md77">Types</a></li>
<li class="level1"><a href="#autotoc_md78">Operations</a><ul><li class="level2"><a href="#autotoc_md79">autodiff.ad</a></li>
<li class="level2"><a href="#autotoc_md80">autodiff.zero</a></li>
<li class="level2"><a href="#autotoc_md81">autodiff.add</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md82">Passes and Phases</a><ul><li class="level2"><a href="#autotoc_md83">Passes</a></li>
<li class="level2"><a href="#autotoc_md84">Phases</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md85">Registered translations</a><ul><li class="level2"><a href="#autotoc_md86">core.icmp.xYgLE (eq)</a></li>
<li class="level2"><a href="#autotoc_md87">core.wrap.add</a></li>
<li class="level2"><a href="#autotoc_md88">core.wrap.mul</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><dl class="section see"><dt>See also</dt><dd>thorin::plug::autodif</dd></dl>
<h1><a class="anchor" id="autotoc_md76"></a>
Dependencies</h1>
<div class="fragment"><div class="line">.plugin mem;</div>
<div class="line">.import compile;</div>
</div><!-- fragment --><p> For derivatives: </p><div class="fragment"><div class="line">.plugin core;</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md77"></a>
Types</h1>
<div class="fragment"><div class="line">.ax %autodiff.Tangent: * -&gt; *, normalize_Tangent;</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md78"></a>
Operations</h1>
<h2><a class="anchor" id="autotoc_md79"></a>
%autodiff.ad</h2>
<p>This axiom operates on functions and types.</p>
<p>For function types the augmented type is computed: <code>(T -&gt; U) =&gt; (T -&gt; U × (U -&gt; T))</code> </p><div class="fragment"><div class="line">.ax %autodiff.AD: * -&gt; *, normalize_AD;</div>
</div><!-- fragment --><p> On closed terms (functions, operators, ho arguments, registered axioms, etc.) the augmented term is returned. The augmented term &lsquo;f&rsquo;<code>returns the result together with the pullback. </code>autodiff f = f' = λ args. (f args, f*)` </p><div class="fragment"><div class="line">.ax %autodiff.ad: Π.[T: *] -&gt; T -&gt; %autodiff.AD T, normalize_ad;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md80"></a>
%autodiff.zero</h2>
<p>Represents universal zero such that <code>(zero T) +_T t = t</code>.</p>
<div class="fragment"><div class="line">.ax %autodiff.zero: Π [T:*] -&gt; T, normalize_zero;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md81"></a>
%autodiff.add</h2>
<p>A universal addition that consumes zeros and defaults to normal addition for scalar types. It lifts additions over types with structure and performs special casing for types with do not allow for addition. The sum construct performs addition over a list of terms.</p>
<p>TODO: how do we handle summations that need memory? (grab current memory?) </p><div class="fragment"><div class="line">.ax %autodiff.add: Π.[T:*] -&gt; [T, T] -&gt; T, normalize_add;</div>
<div class="line">.ax %autodiff.sum: Π [n:.Nat,T:*] -&gt; «n; T» -&gt; T, normalize_sum;</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md82"></a>
Passes and Phases</h1>
<h2><a class="anchor" id="autotoc_md83"></a>
Passes</h2>
<div class="fragment"><div class="line">.ax %autodiff.ad_eval_pass:         %compile.Pass;</div>
<div class="line">.ax %autodiff.ad_zero_pass:         %compile.Pass;</div>
<div class="line">.ax %autodiff.ad_zero_cleanup_pass: %compile.Pass;</div>
<div class="line">.ax %autodiff.ad_ext_cleanup_pass:  %compile.Pass;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md84"></a>
Phases</h2>
<div class="fragment"><div class="line">.let ad_cleanup_phase =</div>
<div class="line">    %compile.phases_to_phase (⊤:.Nat) (</div>
<div class="line">        (%compile.passes_to_phase 1 %autodiff.ad_zero_cleanup_pass),</div>
<div class="line">        (%compile.passes_to_phase 1 %autodiff.ad_ext_cleanup_pass)</div>
<div class="line">    );</div>
<div class="line">.let ad_phase =</div>
<div class="line">    %compile.phases_to_phase (⊤:.Nat) (</div>
<div class="line">        optimization_phase,</div>
<div class="line">        (%compile.passes_to_phase 1 %autodiff.ad_eval_pass),</div>
<div class="line">        (%compile.passes_to_phase 1 %autodiff.ad_zero_pass),</div>
<div class="line">        ad_cleanup_phase</div>
<div class="line">    );</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md85"></a>
Registered translations</h1>
<p>In this section, we define translations for axioms of other plugins. This best would be done using a register mechanism in a third plugin or at least in a separate file.</p>
<p>The general concept is that a call to an axiom is replaced with a call to the augmented axiom. The augmented axiom needs a wrapper for meta arguments (HO-function). Appropiate cps2ds wrappers are introduced to handle that the augmented axioms are in cps where the original axioms were in ds. Example: </p><div class="fragment"><div class="line">mul&#39; =&gt; args -&gt; result*pullback</div>
<div class="line">call: r    = mul  (m,w) (a,b)</div>
<div class="line">res : r,r* = mul&#39; (m,w) (a,b)</div>
</div><!-- fragment --><p> The types (with <code>Int</code> for <code>(Int w)</code>) are: </p><div class="fragment"><div class="line">mul : Π [m:.Nat,w:.Nat] -&gt; [a:Int,b:Int] -&gt; Int</div>
<div class="line">r   : Int</div>
<div class="line">r*  : cn[Int,cn[Int,Int]]</div>
</div><!-- fragment --><p> The pullback has to be in cps for compliance. </p><div class="fragment"><div class="line">mul* := λ s. (s*b,s*a)</div>
<div class="line">mul&#39;_cps : Π [m:.Nat,w:.Nat] -&gt; cn[[Int,Int],cn[Int,   cn[Int,cn[Int,Int]]]]</div>
<div class="line">r,r* = (cps2ds (mul&#39;_cps (m,w))) (a,b)</div>
</div><!-- fragment --><p>The pullback is the derivative with respect to the input (weighted with the out tangent). For arithmetic operations, s is simply multiplied to each input tangent: <code>∂_i f(x1,...,xn) * s</code> You will also come to the conclusion that the applied partial pullback needs to be: <code>sum x_i*(∂_i f(x1,...,xn) * s) = sum x_i*(•)</code> with • as the formula from above This is a direct result from the chain composition with the partial pullback of a tuple. The tuple pullback transports the partial pullbacks of the operands and handles the sums. By its nature the pullback of a tuple needs to be a sum.</p>
<h2><a class="anchor" id="autotoc_md86"></a>
%core.icmp.xYgLE (eq)</h2>
<p>The comparison pullback exists formally but is not used.</p>
<div class="fragment"><div class="line">.fun .extern internal_diff_core_icmp_xYgLE.(s: .Nat)(ab: «2; .Idx s»)@.tt: [.Bool, .Cn[.Bool, .Cn«2; .Idx s»]] =</div>
<div class="line">    return (%core.icmp.sle ab, .fn [.Bool]@.tt: «2; .Idx s» = return ‹2; 0:(.Idx s)›);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md87"></a>
%core.wrap.add</h2>
<p>s ↦ (s, s)</p>
<div class="fragment"><div class="line">.fun .extern internal_diff_core_wrap_add.(s: .Nat)(m: .Nat)(ab: «2; .Idx s»)@.tt: [.Idx s, .Cn[.Idx s, .Cn«2; .Idx s»]] =</div>
<div class="line">    return (%core.wrap.add m ab, .fn (i: .Idx s)@.tt: «2; .Idx s» = return ‹2; i›);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md88"></a>
%core.wrap.mul</h2>
<p>s ↦ (s*b, s*a)</p>
<div class="fragment"><div class="line">.fun .extern internal_diff_core_wrap_mul.(s: .Nat)(m: .Nat)ab::(a b: .Idx s)@.tt: [.Idx s, .Cn[.Idx s, .Cn«2; .Idx s»]] =</div>
<div class="line">    return (%core.wrap.mul m ab, .fn (i: .Idx s)@.tt: «2; .Idx s» = return (%core.wrap.mul m (i, b), %core.wrap.mul m (i, a)));</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
