<!-- HTML header for doxygen 1.9.3-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Thorin: Passes</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<a href="https://github.com/anydsl/thorin2" class="github-corner" title="View source on GitHub">
    <svg viewBox="0 0 250 250" style="position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true">
    <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Thorin<span id="projectnumber">&#160;1.9.0</span>
   </div>
   <div id="projectbrief">The Higher ORder INtermediate representation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_passes.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Passes </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md16">Rewrite Pass</a></li>
<li class="level1"><a href="#autotoc_md17">Fixed-Point Pass</a><ul><li class="level2"><a href="#autotoc_md18">Rewrite</a><ul><li class="level3"><a href="#autotoc_md19">Proxy</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md20">Analyze</a></li>
<li class="level2"><a href="#autotoc_md21">Other Hooks</a></li>
<li class="level2"><a href="#autotoc_md22">Caveats</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p >Passes in Thorin are the main infrastructure and preferred method when implementing code transformations. However, nothing stops you from manually iterating and transforming the program. This is usually only necessary if you need a very specific iteration behavior for your transformation.</p>
<p >Passes are managed by the <a class="el" href="classthorin_1_1_pass_man.html">PassMan</a>ager. You can put together your optimization pipeline like so: </p><div class="fragment"><div class="line">PassMan opt(world);</div>
<div class="line">opt.add&lt;PartialEval&gt;();</div>
<div class="line"><span class="keyword">auto</span> br = opt.add&lt;BetaRed&gt;();</div>
<div class="line"><span class="keyword">auto</span> er = opt.add&lt;EtaRed&gt;();</div>
<div class="line"><span class="keyword">auto</span> ee = opt.add&lt;EtaExp&gt;(er);</div>
<div class="line">opt.add&lt;SSAConstr&gt;(ee);</div>
<div class="line">opt.add&lt;Scalerize&gt;(ee);</div>
<div class="line">opt.add&lt;CopyProp&gt;(br, ee);</div>
<div class="line">opt.run();</div>
</div><!-- fragment --><p> Note how some passes depend on other passes. For example, the <a class="el" href="classthorin_1_1_copy_prop.html">CopyProp</a>agation depends on the <a class="el" href="classthorin_1_1_beta_red.html">BetaRed</a>uction and <a class="el" href="classthorin_1_1_eta_exp.html">EtaExp</a>ansion. In contrast to traditional passes in compilers, Thorin's <a class="el" href="classthorin_1_1_pass_man.html">PassMan</a> will run all passes in tandem and combine the obtained results into the most optimal solution and, hence, avoid the dreaded <em>phase-ordering problem</em>.</p>
<p >There are two kind of passes in Thorin:</p><ol type="1">
<li>Rewrite Pass</li>
<li>Fixed-Point Pass</li>
</ol>
<h1><a class="anchor" id="autotoc_md16"></a>
Rewrite Pass</h1>
<p >In order to write a rewrite pass, you have to inherit from <a class="el" href="classthorin_1_1_r_w_pass.html">RWPass</a>. Usually, you are only interested in looking for code patterns that only occur in specific nominals - typically <a class="el" href="classthorin_1_1_lam.html">Lam</a>bdas. You can filter for these nominals by passing it as template parameter to <a class="el" href="classthorin_1_1_r_w_pass.html">RWPass</a> when inherting from it. The main hook to the <a class="el" href="classthorin_1_1_pass_man.html">PassMan</a>, is the <a class="el" href="classthorin_1_1_r_w_pass_base.html#a416313eda3acb53d2609877c4367d07c">rewrite</a> method. As an example, let's have a look at the <a class="el" href="classthorin_1_1_alloc2_malloc.html">Alloc2Malloc</a> pass. It rewrites <code>alloc</code>/<code>slot</code> calls into their more verbose siblings <code>malloc</code>/<code>mslot</code> that make the size of the alloc'ed type explicit: This is <code><a class="el" href="alloc2malloc_8h.html">alloc2malloc.h</a></code>: </p><div class="fragment"><div class="line"><span class="preprocessor">#ifndef THORIN_PASS_RW_ALLOC2MALLOC_H</span></div>
<div class="line"><span class="preprocessor">#define THORIN_PASS_RW_ALLOC2MALLOC_H</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="pass_8h.html">thorin/pass/pass.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code hl_namespace" href="namespacethorin.html">thorin</a> {</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>Alloc2Malloc : <span class="keyword">public</span> RWPass&lt;Lam&gt; {</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <a class="code hl_function" href="classthorin_1_1_alloc2_malloc.html#ad6a7b807349a09371b88813210b02356">Alloc2Malloc</a>(<a class="code hl_friend" href="classthorin_1_1_r_w_pass_base.html#ae3b741f775f564409b46ea178ca0aefc">PassMan</a>&amp; <a class="code hl_function" href="classthorin_1_1_r_w_pass_base.html#ad2506a9ae875b80c475520552cd969dc">man</a>)</div>
<div class="line">        : <a class="code hl_function" href="classthorin_1_1_r_w_pass.html#a2dab37ccd6894509943c3d0aff357b30">RWPass</a>(<a class="code hl_function" href="classthorin_1_1_r_w_pass_base.html#ad2506a9ae875b80c475520552cd969dc">man</a>, <span class="stringliteral">&quot;alloc2malloc&quot;</span>)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> Def* <a class="code hl_function" href="classthorin_1_1_alloc2_malloc.html#ab39814f9252fe574c46d0677dccff303">rewrite</a>(<span class="keyword">const</span> Def*) <span class="keyword">override</span>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="ttc" id="aclassthorin_1_1_alloc2_malloc_html_ab39814f9252fe574c46d0677dccff303"><div class="ttname"><a href="classthorin_1_1_alloc2_malloc.html#ab39814f9252fe574c46d0677dccff303">thorin::Alloc2Malloc::rewrite</a></div><div class="ttdeci">const Def * rewrite(const Def *) override</div><div class="ttdef"><b>Definition:</b> alloc2malloc.cpp:5</div></div>
<div class="ttc" id="aclassthorin_1_1_alloc2_malloc_html_ad6a7b807349a09371b88813210b02356"><div class="ttname"><a href="classthorin_1_1_alloc2_malloc.html#ad6a7b807349a09371b88813210b02356">thorin::Alloc2Malloc::Alloc2Malloc</a></div><div class="ttdeci">Alloc2Malloc(PassMan &amp;man)</div><div class="ttdef"><b>Definition:</b> alloc2malloc.h:10</div></div>
<div class="ttc" id="aclassthorin_1_1_r_w_pass_base_html_ad2506a9ae875b80c475520552cd969dc"><div class="ttname"><a href="classthorin_1_1_r_w_pass_base.html#ad2506a9ae875b80c475520552cd969dc">thorin::RWPassBase::man</a></div><div class="ttdeci">PassMan &amp; man()</div><div class="ttdef"><b>Definition:</b> pass.h:25</div></div>
<div class="ttc" id="aclassthorin_1_1_r_w_pass_base_html_ae3b741f775f564409b46ea178ca0aefc"><div class="ttname"><a href="classthorin_1_1_r_w_pass_base.html#ae3b741f775f564409b46ea178ca0aefc">thorin::RWPassBase::PassMan</a></div><div class="ttdeci">friend class PassMan</div><div class="ttdef"><b>Definition:</b> pass.h:78</div></div>
<div class="ttc" id="aclassthorin_1_1_r_w_pass_html_a2dab37ccd6894509943c3d0aff357b30"><div class="ttname"><a href="classthorin_1_1_r_w_pass.html#a2dab37ccd6894509943c3d0aff357b30">thorin::RWPass&lt; Lam &gt;::RWPass</a></div><div class="ttdeci">RWPass(PassMan &amp;man, const std::string &amp;name)</div><div class="ttdef"><b>Definition:</b> pass.h:218</div></div>
<div class="ttc" id="anamespacethorin_html"><div class="ttname"><a href="namespacethorin.html">thorin</a></div><div class="ttdef"><b>Definition:</b> cfg.cpp:14</div></div>
<div class="ttc" id="apass_8h_html"><div class="ttname"><a href="pass_8h.html">pass.h</a></div></div>
</div><!-- fragment --><p >The actual <code>rewrite</code> simply inspects the current <code>def</code>. If this happens to be a <code>alloc</code>/<code>slot</code>, it will simply return the more explicit counterpart. This is <code><a class="el" href="alloc2malloc_8cpp.html">alloc2malloc.cpp</a></code>: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="alloc2malloc_8h.html">thorin/pass/rw/alloc2malloc.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code hl_namespace" href="namespacethorin.html">thorin</a> {</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> Def* <a class="code hl_function" href="classthorin_1_1_alloc2_malloc.html#ab39814f9252fe574c46d0677dccff303">Alloc2Malloc::rewrite</a>(<span class="keyword">const</span> Def* def) {</div>
<div class="line">    <span class="keywordflow">if</span> (<span class="keyword">auto</span> alloc = isa&lt;Tag::Alloc&gt;(def)) {</div>
<div class="line">        <span class="keyword">auto</span> [pointee, addr_space] = alloc-&gt;decurry()-&gt;args&lt;2&gt;();</div>
<div class="line">        <span class="keywordflow">return</span> <a class="code hl_function" href="classthorin_1_1_r_w_pass_base.html#af10ca8770ec7dc95aa51583cc1961b19">world</a>().<a class="code hl_function" href="classthorin_1_1_world.html#ad21547e21330be59b54d291f26db8812">op_malloc</a>(pointee, alloc-&gt;arg(), alloc-&gt;dbg());</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">auto</span> slot  = isa&lt;Tag::Slot &gt;(def)) {</div>
<div class="line">        <span class="keyword">auto</span> [pointee, addr_space] = slot-&gt;decurry()-&gt;args&lt;2&gt;();</div>
<div class="line">        <span class="keyword">auto</span> [mem, id] = slot-&gt;args&lt;2&gt;();</div>
<div class="line">        <span class="keywordflow">return</span> <a class="code hl_function" href="classthorin_1_1_r_w_pass_base.html#af10ca8770ec7dc95aa51583cc1961b19">world</a>().<a class="code hl_function" href="classthorin_1_1_world.html#a136d4720a7c162c13db18d4855ba3b06">op_mslot</a>(pointee, mem, <span class="keywordtype">id</span>, slot-&gt;dbg());</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> def;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="ttc" id="aalloc2malloc_8h_html"><div class="ttname"><a href="alloc2malloc_8h.html">alloc2malloc.h</a></div></div>
<div class="ttc" id="aclassthorin_1_1_r_w_pass_base_html_af10ca8770ec7dc95aa51583cc1961b19"><div class="ttname"><a href="classthorin_1_1_r_w_pass_base.html#af10ca8770ec7dc95aa51583cc1961b19">thorin::RWPassBase::world</a></div><div class="ttdeci">World &amp; world()</div><div class="ttdef"><b>Definition:</b> pass.h:271</div></div>
<div class="ttc" id="aclassthorin_1_1_world_html_a136d4720a7c162c13db18d4855ba3b06"><div class="ttname"><a href="classthorin_1_1_world.html#a136d4720a7c162c13db18d4855ba3b06">thorin::World::op_mslot</a></div><div class="ttdeci">const Def * op_mslot(const Def *type, const Def *mem, const Def *id, const Def *dbg={})</div><div class="ttdef"><b>Definition:</b> world.cpp:593</div></div>
<div class="ttc" id="aclassthorin_1_1_world_html_ad21547e21330be59b54d291f26db8812"><div class="ttname"><a href="classthorin_1_1_world.html#ad21547e21330be59b54d291f26db8812">thorin::World::op_malloc</a></div><div class="ttdeci">const Def * op_malloc(const Def *type, const Def *mem, const Def *dbg={})</div><div class="ttdef"><b>Definition:</b> world.cpp:588</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md17"></a>
Fixed-Point Pass</h1>
<p >A fixed-point pass allows you to implement a data-flow analysis. Traditionally, an optimizations performs</p><ol type="1">
<li>the analysis and</li>
<li>runs the actual transformation based upon the analysis info.</li>
</ol>
<p >A fixed-point pass, however, will directly rewrite the code. You <b>optimistically</b> assume that all your assumptions your pass could possibly make about the program simply hold. Now, two things might happen:</p><ol type="1">
<li>You do not run into any contradictions later on, so your optimistic assumptions were in fact sound.</li>
<li>You prove yourself wrong later on.</li>
</ol>
<p >If you find a contradiction to your initial assumption, you have to</p><ol type="1">
<li>undo your mistake by backtracing back to the place where you erroneously made the wrong decision and</li>
<li>correct your assumption such that you do not do the same mistake over and over again.</li>
</ol>
<p >In order to write a fixed-point pass, you have to inherit from <a class="el" href="classthorin_1_1_f_p_pass.html">FPPass</a>. It expects two template parameters. The first one must be the very class you are currently implementing (this is known as <a href="https://en.wikipedia.org/wiki/Curiously_recurring_template_pattern">CRTP</a> in C++). The second one has the same purpose as the template parameter for rewrite passes and will most likely be <a class="el" href="classthorin_1_1_lam.html">Lam</a>.</p>
<h2><a class="anchor" id="autotoc_md18"></a>
Rewrite</h2>
<p >The <code>rewrite</code> works exactly as for rewrite passes. However, this time around, you are guessing that the most optimistic result will happen. If you prove yourself wrong afterwards, you will gradually ascend in a <a href="https://en.wikipedia.org/wiki/Complete_lattice">lattice</a> until the fixed-point pass stabilizes. TODO</p>
<h3><a class="anchor" id="autotoc_md19"></a>
Proxy</h3>
<h2><a class="anchor" id="autotoc_md20"></a>
Analyze</h2>
<p >TODO</p>
<h2><a class="anchor" id="autotoc_md21"></a>
Other Hooks</h2>
<h2><a class="anchor" id="autotoc_md22"></a>
Caveats</h2>
<p >It is important to always construct a valid program. Otherwise, bad things might happen as soon as you toss other passes into the mix. The reason is that the very program you are constructing is the <b>only</b> way to communicate with the other passes without directly sharing information. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.3-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
<script type="text/javascript">
  $(function() {
    toggleButton = document.createElement('doxygen-awesome-dark-mode-toggle')
    toggleButton.title = "Toggle Light/Dark Mode"
    $(document).ready(function(){
      document.getElementById("MSearchBox").parentNode.appendChild(toggleButton)
    })
    $(window).resize(function(){
      document.getElementById("MSearchBox").parentNode.appendChild(toggleButton)
    })
  })
</script>
</body>
</html>
